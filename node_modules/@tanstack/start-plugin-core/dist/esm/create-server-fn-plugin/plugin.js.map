{"version":3,"file":"plugin.js","sources":["../../../src/create-server-fn-plugin/plugin.ts"],"sourcesContent":["import { TRANSFORM_ID_REGEX } from '../constants'\nimport { ServerFnCompiler } from './compiler'\nimport type { LookupConfig, LookupKind } from './compiler'\nimport type { CompileStartFrameworkOptions } from '../start-compiler-plugin/compilers'\nimport type { PluginOption } from 'vite'\n\nfunction cleanId(id: string): string {\n  return id.split('?')[0]!\n}\n\nconst LookupKindsPerEnv: Record<'client' | 'server', Set<LookupKind>> = {\n  client: new Set(['Middleware', 'ServerFn'] as const),\n  server: new Set(['ServerFn'] as const),\n}\n\nconst getLookupConfigurationsForEnv = (\n  env: 'client' | 'server',\n  framework: CompileStartFrameworkOptions,\n): Array<LookupConfig> => {\n  const createServerFnConfig: LookupConfig = {\n    libName: `@tanstack/${framework}-start`,\n    rootExport: 'createServerFn',\n  }\n  if (env === 'client') {\n    return [\n      {\n        libName: `@tanstack/${framework}-start`,\n        rootExport: 'createMiddleware',\n      },\n      {\n        libName: `@tanstack/${framework}-start`,\n        rootExport: 'createStart',\n      },\n\n      createServerFnConfig,\n    ]\n  } else {\n    return [createServerFnConfig]\n  }\n}\nconst SERVER_FN_LOOKUP = 'server-fn-module-lookup'\nexport function createServerFnPlugin(opts: {\n  framework: CompileStartFrameworkOptions\n  directive: string\n  environments: Array<{ name: string; type: 'client' | 'server' }>\n}): PluginOption {\n  const compilers: Record<string /* envName */, ServerFnCompiler> = {}\n\n  function perEnvServerFnPlugin(environment: {\n    name: string\n    type: 'client' | 'server'\n  }): PluginOption {\n    // in server environments, we don't transform middleware calls\n    const transformCodeFilter =\n      environment.type === 'client'\n        ? [/\\.\\s*handler\\(/, /\\.\\s*createMiddleware\\(\\)/]\n        : [/\\.\\s*handler\\(/]\n\n    return {\n      name: `tanstack-start-core::server-fn:${environment.name}`,\n      enforce: 'pre',\n      applyToEnvironment(env) {\n        return env.name === environment.name\n      },\n      transform: {\n        filter: {\n          id: {\n            exclude: new RegExp(`${SERVER_FN_LOOKUP}$`),\n            include: TRANSFORM_ID_REGEX,\n          },\n          code: {\n            include: transformCodeFilter,\n          },\n        },\n        async handler(code, id) {\n          let compiler = compilers[this.environment.name]\n          if (!compiler) {\n            compiler = new ServerFnCompiler({\n              env: environment.type,\n              directive: opts.directive,\n              lookupKinds: LookupKindsPerEnv[environment.type],\n              lookupConfigurations: getLookupConfigurationsForEnv(\n                environment.type,\n                opts.framework,\n              ),\n              loadModule: async (id: string) => {\n                if (this.environment.mode === 'build') {\n                  const loaded = await this.load({ id })\n                  if (!loaded.code) {\n                    throw new Error(`could not load module ${id}`)\n                  }\n                  compiler!.ingestModule({ code: loaded.code, id })\n                } else if (this.environment.mode === 'dev') {\n                  /**\n                   * in dev, vite does not return code from `ctx.load()`\n                   * so instead, we need to take a different approach\n                   * we must force vite to load the module and run it through the vite plugin pipeline\n                   * we can do this by using the `fetchModule` method\n                   * the `captureServerFnModuleLookupPlugin` captures the module code via its transform hook and invokes analyzeModuleAST\n                   */\n                  await this.environment.fetchModule(\n                    id + '?' + SERVER_FN_LOOKUP,\n                  )\n                } else {\n                  throw new Error(\n                    `could not load module ${id}: unknown environment mode ${this.environment.mode}`,\n                  )\n                }\n              },\n              resolveId: async (source: string, importer?: string) => {\n                const r = await this.resolve(source, importer)\n                if (r) {\n                  if (!r.external) {\n                    return cleanId(r.id)\n                  }\n                }\n                return null\n              },\n            })\n            compilers[this.environment.name] = compiler\n          }\n\n          id = cleanId(id)\n          const result = await compiler.compile({ id, code })\n          return result\n        },\n      },\n\n      hotUpdate(ctx) {\n        const compiler = compilers[this.environment.name]\n\n        ctx.modules.forEach((m) => {\n          if (m.id) {\n            const deleted = compiler?.invalidateModule(m.id)\n            if (deleted) {\n              m.importers.forEach((importer) => {\n                if (importer.id) {\n                  compiler?.invalidateModule(importer.id)\n                }\n              })\n            }\n          }\n        })\n      },\n    }\n  }\n\n  return [\n    ...opts.environments.map(perEnvServerFnPlugin),\n    {\n      name: 'tanstack-start-core:capture-server-fn-module-lookup',\n      // we only need this plugin in dev mode\n      apply: 'serve',\n      applyToEnvironment(env) {\n        return !!opts.environments.find((e) => e.name === env.name)\n      },\n      transform: {\n        filter: {\n          id: new RegExp(`${SERVER_FN_LOOKUP}$`),\n        },\n        handler(code, id) {\n          const compiler = compilers[this.environment.name]\n          compiler?.ingestModule({ code, id: cleanId(id) })\n        },\n      },\n    },\n  ]\n}\n"],"names":["id"],"mappings":"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"}