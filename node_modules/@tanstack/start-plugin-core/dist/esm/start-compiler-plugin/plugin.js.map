{"version":3,"file":"plugin.js","sources":["../../../src/start-compiler-plugin/plugin.ts"],"sourcesContent":["import { fileURLToPath, pathToFileURL } from 'node:url'\nimport { createRequire } from 'node:module'\nimport { logDiff } from '@tanstack/router-utils'\n\nimport { VIRTUAL_MODULES } from '@tanstack/start-server-core'\nimport { normalizePath } from 'vite'\nimport path from 'pathe'\nimport { makeIdFiltersToMatchWithQuery } from '@rolldown/pluginutils'\nimport { TRANSFORM_ID_REGEX } from '../constants'\nimport { compileStartOutputFactory } from './compilers'\nimport { transformFuncs } from './constants'\nimport type { Plugin, PluginOption } from 'vite'\nimport type { CompileStartFrameworkOptions } from './compilers'\n\nconst debug =\n  process.env.TSR_VITE_DEBUG &&\n  ['true', 'start-plugin'].includes(process.env.TSR_VITE_DEBUG)\n\nexport type TanStackStartViteOptions = {\n  globalMiddlewareEntry: string\n}\n\nconst tokenRegex = new RegExp(transformFuncs.join('|'))\n\nconst require = createRequire(import.meta.url)\n\nfunction resolveRuntimeFiles(opts: { package: string; files: Array<string> }) {\n  const pkgRoot = resolvePackage(opts.package)\n  const basePath = path.join(pkgRoot, 'dist', 'esm')\n  return opts.files.map((file) => normalizePath(path.join(basePath, file)))\n}\n\nfunction resolvePackage(packageName: string): string {\n  const pkgRoot = path.dirname(require.resolve(packageName + '/package.json'))\n  return pkgRoot\n}\n\nconst transformFilter = {\n  code: tokenRegex,\n  id: {\n    include: TRANSFORM_ID_REGEX,\n    exclude: [\n      VIRTUAL_MODULES.serverFnManifest,\n      // N.B. the following files either just re-export or provide the runtime implementation of those functions\n      // we do not want to include them in the transformation\n      // however, those packages (especially start-client-core ATM) also USE these functions\n      // (namely `createIsomorphicFn` in `packages/start-client-core/src/getRouterInstance.ts`) and thus need to be transformed\n      ...makeIdFiltersToMatchWithQuery([\n        ...resolveRuntimeFiles({\n          package: '@tanstack/start-client-core',\n          files: [\n            'index.js',\n            'createIsomorphicFn.js',\n            'envOnly.js',\n            'serverFnFetcher.js',\n            'createStart.js',\n            'createMiddleware.js',\n          ],\n        }),\n        ...resolveRuntimeFiles({\n          package: '@tanstack/start-server-core',\n          files: ['index.js', 'server-functions-handler.js'],\n        }),\n      ]),\n    ],\n  },\n}\n\nexport function startCompilerPlugin(opts: {\n  framework: CompileStartFrameworkOptions\n  environments: Array<{ name: string; type: 'client' | 'server' }>\n}): PluginOption {\n  const compileStartOutput = compileStartOutputFactory(opts.framework)\n\n  function perEnvCompilerPlugin(environment: {\n    name: string\n    type: 'client' | 'server'\n  }): Plugin {\n    return {\n      name: `tanstack-start-core:compiler:${environment.name}`,\n      enforce: 'pre',\n      applyToEnvironment(env) {\n        return env.name === environment.name\n      },\n      transform: {\n        filter: transformFilter,\n        handler(code, id) {\n          const url = pathToFileURL(id)\n          url.searchParams.delete('v')\n          id = fileURLToPath(url).replace(/\\\\/g, '/')\n\n          if (debug) console.info(`${environment.name} Compiling Start: `, id)\n\n          const compiled = compileStartOutput({\n            code,\n            filename: id,\n            env: environment.type,\n          })\n\n          if (debug) {\n            logDiff(code, compiled.code)\n            console.log('Output:\\n', compiled.code + '\\n\\n')\n          }\n\n          return compiled\n        },\n      },\n    }\n  }\n  return opts.environments.map(perEnvCompilerPlugin)\n}\n"],"names":["require"],"mappings":";;;;;;;;;;AAcA,MAAM,QACJ,QAAQ,IAAI,kBACZ,CAAC,QAAQ,cAAc,EAAE,SAAS,QAAQ,IAAI,cAAc;AAM9D,MAAM,aAAa,IAAI,OAAO,eAAe,KAAK,GAAG,CAAC;AAEtD,MAAMA,WAAU,cAAc,YAAY,GAAG;AAE7C,SAAS,oBAAoB,MAAiD;AAC5E,QAAM,UAAU,eAAe,KAAK,OAAO;AAC3C,QAAM,WAAW,KAAK,KAAK,SAAS,QAAQ,KAAK;AACjD,SAAO,KAAK,MAAM,IAAI,CAAC,SAAS,cAAc,KAAK,KAAK,UAAU,IAAI,CAAC,CAAC;AAC1E;AAEA,SAAS,eAAe,aAA6B;AACnD,QAAM,UAAU,KAAK,QAAQA,SAAQ,QAAQ,cAAc,eAAe,CAAC;AAC3E,SAAO;AACT;AAEA,MAAM,kBAAkB;AAAA,EACtB,MAAM;AAAA,EACN,IAAI;AAAA,IACF,SAAS;AAAA,IACT,SAAS;AAAA,MACP,gBAAgB;AAAA;AAAA;AAAA;AAAA;AAAA,MAKhB,GAAG,8BAA8B;AAAA,QAC/B,GAAG,oBAAoB;AAAA,UACrB,SAAS;AAAA,UACT,OAAO;AAAA,YACL;AAAA,YACA;AAAA,YACA;AAAA,YACA;AAAA,YACA;AAAA,YACA;AAAA,UAAA;AAAA,QACF,CACD;AAAA,QACD,GAAG,oBAAoB;AAAA,UACrB,SAAS;AAAA,UACT,OAAO,CAAC,YAAY,6BAA6B;AAAA,QAAA,CAClD;AAAA,MAAA,CACF;AAAA,IAAA;AAAA,EACH;AAEJ;AAEO,SAAS,oBAAoB,MAGnB;AACf,QAAM,qBAAqB,0BAA0B,KAAK,SAAS;AAEnE,WAAS,qBAAqB,aAGnB;AACT,WAAO;AAAA,MACL,MAAM,gCAAgC,YAAY,IAAI;AAAA,MACtD,SAAS;AAAA,MACT,mBAAmB,KAAK;AACtB,eAAO,IAAI,SAAS,YAAY;AAAA,MAClC;AAAA,MACA,WAAW;AAAA,QACT,QAAQ;AAAA,QACR,QAAQ,MAAM,IAAI;AAChB,gBAAM,MAAM,cAAc,EAAE;AAC5B,cAAI,aAAa,OAAO,GAAG;AAC3B,eAAK,cAAc,GAAG,EAAE,QAAQ,OAAO,GAAG;AAE1C,cAAI,MAAO,SAAQ,KAAK,GAAG,YAAY,IAAI,sBAAsB,EAAE;AAEnE,gBAAM,WAAW,mBAAmB;AAAA,YAClC;AAAA,YACA,UAAU;AAAA,YACV,KAAK,YAAY;AAAA,UAAA,CAClB;AAED,cAAI,OAAO;AACT,oBAAQ,MAAM,SAAS,IAAI;AAC3B,oBAAQ,IAAI,aAAa,SAAS,OAAO,MAAM;AAAA,UACjD;AAEA,iBAAO;AAAA,QACT;AAAA,MAAA;AAAA,IACF;AAAA,EAEJ;AACA,SAAO,KAAK,aAAa,IAAI,oBAAoB;AACnD;"}